name: Drift skia Release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

env:
  GO_VERSION: "1.25.5"
  NDK_VERSION: "27.1.12297006"

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y ninja-build python3
      - name: Setup Android NDK
        run: |
          SDKMANAGER="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
          yes | "$SDKMANAGER" --install "ndk;$NDK_VERSION" || true
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/$NDK_VERSION" >> "$GITHUB_ENV"
      - name: Fetch Skia
        run: ./scripts/fetch_skia.sh
      - name: Build Skia for Android
        run: ./scripts/build_skia_android.sh
      - name: Package Android artifacts
        run: ./scripts/build_skia_release.sh --android --skip-build
      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: drift-skia-android
          path: |
            dist/drift_skia/*.tar.gz

  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Install build tools
        run: brew install ninja
      - name: Fetch Skia
        run: ./scripts/fetch_skia.sh
      - name: Build Skia for iOS
        run: ./scripts/build_skia_ios.sh
      - name: Package iOS artifacts
        run: ./scripts/build_skia_release.sh --ios --skip-build
      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: drift-skia-ios
          path: |
            dist/drift_skia/*.tar.gz

  release:
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    steps:
      - uses: actions/checkout@v4
      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: drift-skia-android
          path: dist/drift_skia
      - name: Download iOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: drift-skia-ios
          path: dist/drift_skia
      - name: Generate manifest with checksums
        id: manifest
        run: |
          set -euo pipefail
          ref_name="${GITHUB_REF_NAME:-}"
          if [[ -z "$ref_name" || "$ref_name" != v* ]]; then
            echo "Expected v* tag" >&2
            exit 1
          fi
          drift_version="$ref_name"
          if [[ -z "$drift_version" ]]; then
            echo "Drift version not set" >&2
            exit 1
          fi
          echo "drift_version=$drift_version" >> "$GITHUB_OUTPUT"
          echo "release_tag=$ref_name" >> "$GITHUB_OUTPUT"
          dist_dir="dist/drift_skia"
          android_tar="$dist_dir/drift-$drift_version-android.tar.gz"
          ios_tar="$dist_dir/drift-$drift_version-ios.tar.gz"
          if [[ ! -f "$android_tar" || ! -f "$ios_tar" ]]; then
            echo "Missing Skia tarballs in $dist_dir" >&2
            exit 1
          fi
          android_sha=$(sha256sum "$android_tar" | cut -d ' ' -f1)
          ios_sha=$(sha256sum "$ios_tar" | cut -d ' ' -f1)
          out_dir="$dist_dir/$drift_version"
          mkdir -p "$out_dir"
          cat > "$out_dir/manifest.json" <<EOF
          {
            "drift_version": "${drift_version}",
            "android": {
              "tarball": "drift-${drift_version}-android.tar.gz",
              "sha256": "${android_sha}",
              "arches": ["arm64", "arm", "amd64"]
            },
            "ios": {
              "tarball": "drift-${drift_version}-ios.tar.gz",
              "sha256": "${ios_sha}",
              "device_arches": ["arm64"],
              "simulator_arches": ["arm64", "x64"]
            }
          }
          EOF
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.manifest.outputs.release_tag }}
          name: ${{ steps.manifest.outputs.release_tag }}
          files: |
            dist/drift_skia/*.tar.gz
            dist/drift_skia/*/manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
