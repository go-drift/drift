#!/usr/bin/env bash
# driftw - Drift wrapper for IDE builds (macOS/Linux only)
# Locates drift CLI and runs it with provided arguments

set -e

# Build candidate list
candidates=("drift")
[[ -n "$GOBIN" ]] && candidates+=("$GOBIN/drift")
[[ -n "$GOPATH" ]] && candidates+=("$GOPATH/bin/drift")
candidates+=(
    "$HOME/go/bin/drift"
    "$HOME/.local/bin/drift"
    "/usr/local/bin/drift"
    "/opt/homebrew/bin/drift"
)

# Try each candidate
for candidate in "${candidates[@]}"; do
    if [[ "$candidate" == /* ]]; then
        [[ -x "$candidate" ]] && exec "$candidate" "$@"
    else
        resolved=$(command -v "$candidate" 2>/dev/null) && [[ -x "$resolved" ]] && exec "$resolved" "$@"
    fi
done

# Last resort: ask `go` for GOPATH (handles non-default GOPATH in IDE environments)
for go_bin in "go" "/usr/local/go/bin/go" "/opt/homebrew/bin/go"; do
    go_path=$(command -v "$go_bin" 2>/dev/null || true)
    if [[ -x "$go_path" ]]; then
        gopath=$("$go_path" env GOPATH 2>/dev/null || true)
        [[ -x "$gopath/bin/drift" ]] && exec "$gopath/bin/drift" "$@"
        break
    fi
done

echo "Error: drift not found in PATH or common locations." >&2
echo "Install with: go install github.com/go-drift/drift/cmd/drift@latest" >&2
echo "Or ensure drift is in one of: PATH, \$GOBIN, \$GOPATH/bin, ~/go/bin, ~/.local/bin, /usr/local/bin" >&2
exit 1
