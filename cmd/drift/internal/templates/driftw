#!/usr/bin/env bash
# driftw - Drift wrapper for IDE builds (macOS/Linux only)
# Locates drift CLI and runs it with provided arguments.
#
# Resolution order:
#   1. .drift.env (auto-generated by drift eject/compile with absolute path)
#   2. drift on PATH
#   3. Well-known install locations

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Primary: use .drift.env (generated by drift eject and drift compile)
if [[ -f "$SCRIPT_DIR/.drift.env" ]]; then
    source "$SCRIPT_DIR/.drift.env"
    [[ -x "$DRIFT_BIN" ]] && exec "$DRIFT_BIN" "$@"
fi

# Fallback: try PATH and well-known locations
for candidate in \
    "drift" \
    "${GOBIN:+$GOBIN/drift}" \
    "${GOPATH:+$GOPATH/bin/drift}" \
    "$HOME/go/bin/drift" \
    "$HOME/.local/bin/drift" \
    "/usr/local/bin/drift" \
    "/opt/homebrew/bin/drift"; do
    [[ -z "$candidate" ]] && continue
    if [[ "$candidate" == /* ]]; then
        [[ -x "$candidate" ]] && exec "$candidate" "$@"
    else
        resolved=$(command -v "$candidate" 2>/dev/null || true)
        [[ -x "$resolved" ]] && exec "$resolved" "$@"
    fi
done

echo "Error: drift not found." >&2
echo "Run 'drift compile $(basename "$(dirname "$SCRIPT_DIR")")' to generate .drift.env," >&2
echo "or install with: go install github.com/go-drift/drift/cmd/drift@latest" >&2
exit 1
