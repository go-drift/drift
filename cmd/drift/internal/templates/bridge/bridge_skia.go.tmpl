//go:build android || darwin || ios
// +build android darwin || ios

package main

// #include <stdint.h>
import "C"

import (
	"unsafe"

	"github.com/go-drift/drift/pkg/engine"
)

// DriftSkiaInitGL initializes a Skia GL context using the current GL context.
//
//export DriftSkiaInitGL
func DriftSkiaInitGL() C.int {
	if err := engine.InitSkiaGL(); err != nil {
		return 1
	}
	return 0
}

// DriftSkiaRenderGL renders a frame using the Skia GL backend.
//
//export DriftSkiaRenderGL
func DriftSkiaRenderGL(width C.int, height C.int) C.int {
	if err := engine.RenderSkiaGL(int(width), int(height)); err != nil {
		return 1
	}
	return 0
}

// DriftSkiaInitMetal initializes a Skia Metal context.
//
//export DriftSkiaInitMetal
func DriftSkiaInitMetal(device C.uintptr_t, queue C.uintptr_t) C.int {
	if err := engine.InitSkiaMetal(unsafe.Pointer(uintptr(device)), unsafe.Pointer(uintptr(queue))); err != nil {
		return 1
	}
	return 0
}

// DriftSkiaRenderMetal renders a frame using the Skia Metal backend.
//
//export DriftSkiaRenderMetal
func DriftSkiaRenderMetal(width C.int, height C.int, texture C.uintptr_t) C.int {
	if err := engine.RenderSkiaMetal(int(width), int(height), unsafe.Pointer(uintptr(texture))); err != nil {
		return 1
	}
	return 0
}

// DriftNeedsFrame returns 1 if a new frame should be rendered, 0 otherwise.
// Call this before acquiring a Metal drawable to skip unnecessary render cycles.
//
//export DriftNeedsFrame
func DriftNeedsFrame() C.int {
	if engine.NeedsFrame() {
		return 1
	}
	return 0
}

// DriftSkiaLastError returns a pointer to a C string describing the last Skia error.
// The native caller is responsible for freeing the returned string by calling free().
//
//export DriftSkiaLastError
func DriftSkiaLastError() *C.char {
	err := engine.LastSkiaError()
	if err == "" {
		return nil
	}
	return C.CString(err)
}
